version: "3.8"

services:
  caddy:
    build: .
    container_name: caddy
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - ACME_EMAIL=${ACME_EMAIL}
      - PORKBUN_API_KEY=${PORKBUN_API_KEY}
      - PORKBUN_API_SECRET_KEY=${PORKBUN_API_SECRET_KEY}
    volumes:
      - ${CADDY_DATA:-./data}:/data
      - ${CADDY_CONFIG:-./config}:/config
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    networks:
      vlan60:
        ipv4_address: ${CADDY_IP:-10.20.60.10}
      caddy-internal:

  whoami:
    image: traefik/whoami:latest
    container_name: caddy-whoami
    restart: unless-stopped
    networks:
      - caddy-internal

networks:
  vlan60:
    driver: macvlan
    driver_opts:
      parent: ${SYNOLOGY_INTERFACE:-eth0.60}
    ipam:
      config:
        - subnet: ${VLAN60_SUBNET:-10.20.60.0/24}
          gateway: ${VLAN60_GATEWAY:-10.20.60.1}
  caddy-internal:
    driver: bridge
