version: "3.8"

services:
  db:
    image: postgres:${POSTGRES_VERSION:-15}-alpine
    container_name: gitea-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${GITEA_DB_USER:-gitea}
      - POSTGRES_PASSWORD=${GITEA_DB_PASSWORD}
      - POSTGRES_DB=${GITEA_DB_NAME:-gitea}
      - TZ=${TZ}
    volumes:
      - ${GITEA_POSTGRES_DATA:-./postgres}:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL","pg_isready -U ${GITEA_DB_USER:-gitea} -d ${GITEA_DB_NAME:-gitea}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gitea-internal

  server:
    image: ${GITEA_IMAGE:-docker.gitea.com/gitea}:${GITEA_VERSION:-1.25.2}
    container_name: gitea
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      - USER_UID=${GITEA_UID:-1000}
      - USER_GID=${GITEA_GID:-1000}
      - TZ=${TZ}
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=db:5432
      - GITEA__database__NAME=${GITEA_DB_NAME:-gitea}
      - GITEA__database__USER=${GITEA_DB_USER:-gitea}
      - GITEA__database__PASSWD=${GITEA_DB_PASSWORD}
      - GITEA__server__DOMAIN=${GITEA_DOMAIN}
      - GITEA__server__SSH_DOMAIN=${GITEA_SSH_DOMAIN}
      - GITEA__server__ROOT_URL=${GITEA_ROOT_URL}
    volumes:
      - ${GITEA_DATA:-./gitea}:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      gitea-internal:
      vlan60:
        ipv4_address: ${GITEA_IP:-10.20.60.11}

networks:
  gitea-internal:
    driver: bridge
  vlan60:
    driver: macvlan
    driver_opts:
      parent: ${SYNOLOGY_INTERFACE:-eth0.60}
    ipam:
      config:
        - subnet: ${VLAN60_SUBNET:-10.20.60.0/24}
          gateway: ${VLAN60_GATEWAY:-10.20.60.1}
